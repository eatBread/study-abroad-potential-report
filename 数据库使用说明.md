# 数据库系统使用说明

## 系统概述

本系统已从纯前端应用改造为带数据库的后端应用，使用 SQLite 数据库存储数据。

## 启动系统

```bash
npm start
```

系统将在 `http://localhost:3000` 启动，同时提供前端页面和API接口。

## 数据库结构

### 1. 机构码表 (institutions)

存储机构码信息，用于验证用户身份。

**字段说明：**
- `id`: 主键
- `code`: 机构码（唯一）
- `name`: 机构名称（可选）
- `is_completed`: 是否已填写问卷（0=未填写，1=已填写）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2. 问卷表 (surveys)

存储用户提交的问卷数据。

**字段说明：**
- `id`: 主键
- `institution_code`: 机构码（外键）
- `student_name`: 学生姓名
- `survey_data`: 问卷数据（JSON格式）
- `status`: 状态（pending=待处理，completed=已完成）
- `created_at`: 创建时间
- `updated_at`: 更新时间
- `survey_start_time`: 问卷开始时间
- `survey_end_time`: 问卷结束时间

## 使用流程

### 1. 创建机构码

机构码需要先在数据库中创建，用户才能使用该机构码填写问卷。

**方法一：使用API创建（推荐）**

可以通过API接口创建机构码：

```bash
curl -X POST http://localhost:3000/api/institutions \
  -H "Content-Type: application/json" \
  -d '{"code": "TEST001", "name": "测试机构"}'
```

**方法二：直接操作数据库**

可以使用SQLite命令行工具或数据库管理工具直接插入：

```sql
INSERT INTO institutions (code, name) VALUES ('TEST001', '测试机构');
```

### 2. 用户填写问卷流程

1. 用户访问 `http://localhost:3000/home.html`
2. 点击"开始问卷"，输入机构码和学生姓名
3. 系统验证机构码是否存在
4. 如果机构码已填写过，会提示无法重复填写
5. 验证通过后，进入问卷页面填写
6. 提交问卷后，跳转到感谢页面
7. 数据自动保存到数据库

### 3. 工作人员查看和管理

1. 访问 `http://localhost:3000/admin.html`
2. 点击"后台管理"标签页
3. 可以看到所有已提交的问卷列表
4. 点击任意问卷卡片，可以查看详情并填充到"学生信息录入"表单
5. 补充数据后，可以生成报告

## API接口说明

### 验证机构码
```
POST /api/institutions/validate
Body: { "code": "机构码" }
```

### 创建机构码
```
POST /api/institutions
Body: { "code": "机构码", "name": "机构名称" }
```

### 提交问卷
```
POST /api/surveys
Body: { 问卷数据对象 }
```

### 获取所有问卷
```
GET /api/surveys
```

### 获取单个问卷
```
GET /api/surveys/:id
```

### 更新问卷状态
```
PUT /api/surveys/:id/status
Body: { "status": "completed" }
```

## 注意事项

1. **机构码唯一性**：每个机构码只能填写一次问卷，系统会自动标记为已填写
2. **无需登录**：系统不需要用户注册登录，通过机构码验证身份
3. **数据备份**：数据库文件为 `database.sqlite`，建议定期备份
4. **端口冲突**：如果3000端口被占用，可以修改 `server.js` 中的 `PORT` 变量

## 数据库文件位置

数据库文件：`/Users/brettli/ques/database.sqlite`

首次运行系统时会自动创建数据库和表结构。

